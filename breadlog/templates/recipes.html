{% extends 'base.html' %}

{% block header %} 
{% if current_user.is_authenticated %} 
    <div class="content-title">
        <h1><a class="title" href="{{ url_for('index') }}">BREAD EXPERIMENT LOG</a></h1>
        <br>
        <h4>Welcome back, {{ current_user.email }}</h4>
    </div> 
    {% endif %}
{% endblock %}

{% block body %}
<div class="row">
    <!--Sidebar of existing recipes-->
    <div class="col-4">
        <form method="POST" action=""> <!--action="" means post to the same route we're on-->
            {{ form.hidden_tag() }} <!--add a CSRF token-->
            <fieldset>
                <div>
                    {{ form.recipe_name.label(class="") }}<span></span>
                    {{ form.recipe_name(class="")}}
                    {{ form.submit(class="call-to-action-small") }}
                </div>
            </fieldset>
        </form>
        <br>
        {% if recipes|length < 1 %}
        <h4>No recipes yet. Try creating a new one.</h4> 
        {% else %}
        <div class="box">
            <h3 class="table-header">RECIPE BOX</h3>
            <table>
                {% for recipe in recipes %}
                    <tr>
                        <td><button class="recipe-name" data-name="{{ recipe.id }}">{{ recipe.name }}</button></td>
                        <td><a href="{{ url_for('edit_recipe', recipe_id=recipe.id) }}"><i class="fa fa-edit"></i></a></td>
                        <td><a href="{{ url_for('delete_recipe', recipe_id=recipe.id) }}"><i class="fa fa-trash"></i></a></td>
                    </tr>
                {% endfor %}
            </table>
        </div>
        {% endif %}
    </div>
    <!--On the right we'll have create new recipe + space to load existing recipe-->
    <div class="col-8">
        <div class="col-8">
            <div id="placeholder"class="placeholder-show">
                {% if recipes | length < 1 %}
                <p>No recipes yet, create one to start</p>
                {% else %}
                <!--Show information for the first recipe-->
                <h1>{{ recipes[0].name }}</h1>
                <hr>
                <p>Total time: {{ recipes[0].total_minutes }} minutes</p>
                <h4>Ingredients</h4>
                <p>PLACEHOLDER FOR TOTAL INGREDIENTS LIST</p>
                {% for step in recipes[0].steps %}
                <h4>Step {{ step.step_number }} </h4>
                <p>Time: {{ step.minutes }} minutes  START TIMER</p>
                {% endfor %}
                {% endif %}
            </div>
            <div id="requested-recipe" class="placeholder-hide">
                <h1 id="recipe-name"></h1>
                <hr>
                <p id="recipe-min"></p>
                <h4>Ingredients</h4>
                <p>PLACEHOLDER FOR TOTAL INGREDIENTS LIST</p>
                <div id="steps"></div>
            </div>
    </div>
</div>

{% endblock %} 


{% block script %}
<script> 
    // Check that DOM has loaded and add onclick event for recipe names
    document.addEventListener('DOMContentLoaded', () => {
        var buttons = document.querySelectorAll('button.recipe-name'); 
        for (var i = 0; i < buttons.length; i++) {
            buttons[i].onclick = function() {
                var url = 'recipe/id/' + this.dataset.name; 
                makeRequest(url); 
            }; 
        }
    }); 

    // Make a HTTP get request for recipe information
    function makeRequest(url) {
        httpRequest = new XMLHttpRequest();
        
        httpRequest.onreadystatechange = function() {
            if (httpRequest.readyState === XMLHttpRequest.DONE && httpRequest.status === 200) {
                var response = JSON.parse(httpRequest.responseText); 
                display(response);
            }
        }
        httpRequest.open('GET', url); 
        httpRequest.send(); 
    }

    // Hide current display in page and replace with updated recipe data 
    function display(response) {
        // Hide default response 
        document.getElementById('placeholder').className = 'placeholder-hide';
        // Get the requested response div 
        let divElem = document.getElementById('requested-recipe'); 
        // Remove any requested steps
        let stepDiv = document.getElementById('steps');
        stepDiv.innerHTML = '';
        //Show the requested response 
        divElem.className = 'placeholder-show';
        // Populate new recipe title
        let title = document.getElementById('recipe-name'); 
        title.innerText = response['name'];

        let timeElem = document.getElementById('recipe-min'); 
        timeElem.innerText = 'Total time: ' + response['total_minutes'] +  ' minutes';
        
        for (var i=0; i < response['steps'].length; i++) {
            let stepTitle = document.createElement('h4')
            stepTitle.innerText = "Step " + response['steps'][i]['step_number'] + ": " + response['steps'][i]['action']; 
            stepDiv.appendChild(stepTitle);
            
            let stepTime = document.createElement('p'); 
            stepTime.innerText = 'Time: ' + response['steps'][i]['minutes'] + ' minutes  START TIMER';
            stepDiv.appendChild(stepTime);
        }
    }

    
</script>
{% endblock %}